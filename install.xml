<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>E-Leads OpenCart 2</name>
  <code>eleads_oc2</code>
  <version>0.1.6</version>
  <author>E-Leads</author>

  <file path="catalog/controller/startup/seo_url.php">
    <operation>
      <search><![CDATA[public function index() {]]></search>
      <add position="after"><![CDATA[
		// E-Leads feed route
		if (isset($this->request->get['_route_'])) {
			$route = trim($this->request->get['_route_'], '/');
			if (preg_match('#^eleads-yml/([a-zA-Z_-]+)\.xml$#', $route, $m)) {
				$this->request->get['route'] = 'extension/module/eleads';
				$this->request->get['lang'] = $m[1];
				return;
			}
		}
]]></add>
    </operation>
  </file>

  <file path="admin/model/catalog/product.php">
    <operation>
      <search><![CDATA[return $product_id;]]></search>
      <add position="before"><![CDATA[
		// E-Leads sync: product created
		if ($this->config->get('module_eleads_sync_enabled')) {
			require_once DIR_SYSTEM . 'library/eleads/bootstrap.php';
			require_once DIR_SYSTEM . 'library/eleads/oc_adapter.php';
			$adapter = new EleadsOcAdapter($this->registry);
			$settings = $adapter->getSettings();
			$service = new EleadsSyncService($settings, $adapter, new EleadsSyncPayloadBuilder(), new EleadsApiClient());
			$lang_code = (string)$this->config->get('config_admin_language');
			$lang_code = $lang_code === 'ua' ? 'uk' : $lang_code;
			$service->syncProductCreated($product_id, $lang_code);
		}
]]></add>
    </operation>

    <operation>
      <search index="2"><![CDATA[$this->cache->delete('product');]]></search>
      <add position="before"><![CDATA[
		// E-Leads sync: product updated
		if ($this->config->get('module_eleads_sync_enabled')) {
			require_once DIR_SYSTEM . 'library/eleads/bootstrap.php';
			require_once DIR_SYSTEM . 'library/eleads/oc_adapter.php';
			$adapter = new EleadsOcAdapter($this->registry);
			$settings = $adapter->getSettings();
			$service = new EleadsSyncService($settings, $adapter, new EleadsSyncPayloadBuilder(), new EleadsApiClient());
			$lang_code = (string)$this->config->get('config_admin_language');
			$lang_code = $lang_code === 'ua' ? 'uk' : $lang_code;
			$service->syncProductUpdated($product_id, $lang_code);
		}
]]></add>
    </operation>

    <operation>
      <search><![CDATA[public function deleteProduct($product_id) {]]></search>
      <add position="after"><![CDATA[
		$__eleads_deleted_product_id = (int)$product_id;
]]></add>
    </operation>

    <operation>
      <search index="3"><![CDATA[$this->cache->delete('product');]]></search>
      <add position="after"><![CDATA[
		// E-Leads sync: product deleted
		if (isset($__eleads_deleted_product_id) && $this->config->get('module_eleads_sync_enabled')) {
			require_once DIR_SYSTEM . 'library/eleads/bootstrap.php';
			require_once DIR_SYSTEM . 'library/eleads/oc_adapter.php';
			$adapter = new EleadsOcAdapter($this->registry);
			$settings = $adapter->getSettings();
			$service = new EleadsSyncService($settings, $adapter, new EleadsSyncPayloadBuilder(), new EleadsApiClient());
			$lang_code = (string)$this->config->get('config_admin_language');
			$lang_code = $lang_code === 'ua' ? 'uk' : $lang_code;
			$service->syncProductDeleted($__eleads_deleted_product_id, $lang_code);
		}
]]></add>
    </operation>
  </file>
</modification>
